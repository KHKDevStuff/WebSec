<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan History | Web Security Scanner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-alt"></i> Web Security Scanner
            </div>
            <ul class="nav-links">
                <li><a href="{{ url_for('index') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li class="active"><a href="#"><i class="fas fa-history"></i> History</a></li>
                <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <header>
                <h2>Scan History</h2>
                <div class="status-indicator">
                    User: <span class="status-online">{{ current_user.username }} ({{ current_user.role|upper }})</span>
                </div>
            </header>

            <div class="content-section">
                <div class="history-container">
                    {% if scans %}
                    {% for scan in scans %}
                    <div class="history-item">
                        <div class="hist-info">
                            <div class="hist-target">{{ scan.target }}</div>
                            <div style="color: var(--text-muted); font-size: 0.9rem;">
                                {{ scan.timestamp.strftime('%Y-%m-%d %H:%M') }}
                                {% if current_user.role == 'admin' %}
                                <span style="margin-left: 10px; color: var(--accent);">
                                    <i class="fas fa-user-circle"></i> {{ scan.user.username }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="hist-score">
                            Risk Score: <strong>{{ scan.risk_score }}</strong>
                        </div>
                        <div class="hist-actions">
                            <button onclick="viewScan({{ scan.id }})" class="btn-icon" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="downloadPDF({{ scan.id }})" class="btn-icon" title="Download PDF">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            <button onclick="deleteScan({{ scan.id }})" class="btn-icon" title="Delete Scan"
                                style="color: var(--danger); border-color: rgba(255, 51, 51, 0.3);">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="empty-msg">No scans performed yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Detailed Scan View Modal/Section (Hidden by default) -->
            <div id="scan-detail-view" class="content-section hidden">
                <div class="results-header">
                    <h2>Scan Details: <span id="detail-target" class="accent-text"></span></h2>
                    <div class="report-actions">
                        <button class="btn-secondary" onclick="exportCurrentDetailPDF()">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </button>
                        <button class="btn-secondary" onclick="closeDetailView()">
                            <i class="fas fa-arrow-left"></i> Back to History
                        </button>
                    </div>
                </div>
                <div class="risk-badge-container">
                    Risk Score: <span id="detail-score">0.0</span>/10
                </div>

                <div class="results-grid">
                    <div class="card val-list">
                        <h3>Vulnerabilities Detected</h3>
                        <ul id="detail-vuln-list" class="vuln-items"></ul>
                    </div>
                    <div class="card details-panel">
                        <h3>System Info</h3>
                        <p><strong>IP:</strong> <span id="detail-ip"></span></p>
                        <p><strong>User:</strong> <span id="detail-user"></span></p>
                        <p><strong>Date:</strong> <span id="detail-date"></span></p>
                    </div>
                </div>
            </div>

            <script>
                // Simple inline script for history view logic
                let currentDetailId = null;

                async function viewScan(scanId) {
                    try {
                        const response = await fetch(`/scan_details/${scanId}`);
                        const data = await response.json();

                        if (data.error) {
                            alert(data.error);
                            return;
                        }

                        currentDetailId = scanId;

                        // Populate Detail View
                        document.getElementById('detail-target').innerText = data.target;
                        document.getElementById('detail-score').innerText = data.risk_score;
                        document.getElementById('detail-ip').innerText = data.ip_address;
                        document.getElementById('detail-user').innerText = data.username || 'Unknown';
                        document.getElementById('detail-date').innerText = data.timestamp;

                        const list = document.getElementById('detail-vuln-list');
                        list.innerHTML = '';

                        const vulns = JSON.parse(data.vulnerabilities || '[]');
                        if (vulns.length === 0) {
                            list.innerHTML = '<li class="vuln-item">No vulnerabilities found.</li>';
                        } else {
                            vulns.forEach(v => {
                                const li = document.createElement('li');
                                li.className = `vuln-item severity-${v.severity}`;
                                li.innerHTML = `<strong>[${v.severity}] ${v.name}</strong><br><small>${v.description}</small>`;
                                list.appendChild(li);
                            });
                        }

                        // Show Detail View
                        document.querySelector('.history-container').style.display = 'none';
                        document.querySelector('header').style.display = 'none'; // Hide main header to avoid clutter
                        document.getElementById('scan-detail-view').classList.remove('hidden');

                    } catch (e) {
                        console.error(e);
                        alert("Failed to load scan details");
                    }
                }

                function closeDetailView() {
                    document.getElementById('scan-detail-view').classList.add('hidden');
                    document.querySelector('.history-container').style.display = 'block';
                    document.querySelector('header').style.display = 'flex';
                }

                function downloadPDF(scanId) {
                    // We need to fetch details first then define how export_pdf works with ID or payload
                    // Since export_pdf expects JSON payload, we should probably fetch first or update export_pdf to accept ID
                    // Updating export_pdf to accept ID is cleaner but let's stick to consistent JSON payload for now
                    // actually, let's just make a new endpoint for downloading by ID
                    window.location.href = `/download_scan_pdf/${scanId}`;
                }

                function exportCurrentDetailPDF() {
                    if (currentDetailId) {
                        downloadPDF(currentDetailId);
                    }
                }

                async function deleteScan(scanId) {
                    if (!confirm("Are you sure you want to permanently delete this scan record?")) return;

                    try {
                        const response = await fetch(`/delete_scan/${scanId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (response.ok) {
                            // Reload page to reflect changes
                            window.location.reload();
                        } else {
                            alert(data.error || "Failed to delete scan");
                        }
                    } catch (e) {
                        console.error(e);
                        alert("Error deleting scan record");
                    }
                }
            </script>
        </main>
    </div>
</body>

</html>